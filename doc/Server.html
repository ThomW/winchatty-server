<html>
   <head>
      <title>WinChatty API - Server Documentation</title>
      <link rel="stylesheet" type="text/css" href="Style.css"></style>
   </head>
   <body>
      <span><a href="index.html"><img src="App48.png" align="left">WinChatty API</a></span>
      <hr noshade color="#3A2E32">
      <h1>Server Installation</h1>
      <h2>Prerequisites</h2>
      <ul>
         <li>PHP 5.2.0+
         <li>libcurl installed
         <li>allow_url_fopen turned on in php.ini
      </ul>
      <h2>Procedure</h2>
      <p>
         The package should contain all files needed to run the server.  Drop them
         in a folder on your webserver that is accessible to the web.  Then, do the 
         following:
         <ol>
            <li>
               Change ownership of the <tt>data</tt> folder to the Apache user, and set the
               proper permissions.  On my Ubuntu server, the Apache user is www-data;
               this may be different for you.<br>
               <tt>
                  $ chmod --recursive 755 data/<br>
                  $ sudo chown --recursive www-data:www-data data/
               </tt>
            </li>
            <li>
               Change the paths in <tt>include/Config.php</tt>.  
               The directories have already been created for you (this is the <tt>data</tt>
               directory), you just have to change the base paths to match where
               you've installed the files physically on your server. 
            </li>
            <li>
               Add mod_rewrite rules to your Apache configuration.  On my Ubuntu
               server, this is <tt>/etc/apache2/sites-available/default</tt>.
               This is only needed for the JSON API.  The AMF and Hessian APIs will work properly
               without any rewrite rules.  If you have installed the files at a 
               location other than the root of your domain, then you will need to
               adapt these lines accordingly.<br>
               <tt>
                  &lt;IfModule mod_rewrite.c&gt;<br>
                  &nbsp;RewriteEngine on<br>
                  &nbsp;RewriteRule ^/service/gateway[/]*$ /service/gateway.php<br>
                  &nbsp;RewriteRule ^/chatty/about$ /classic/about.php<br>
                  &nbsp;RewriteRule ^/chatty/index\.json$ /classic/getStory.php<br>
                  &nbsp;RewriteRule ^/chatty/([0-9]+)\.json$ /classic/getStory.php?story=$1<br>
                  &nbsp;RewriteRule ^/chatty/([0-9]+)\.([0-9]+)\.json$ /classic/getStory.php?story=$1&amp;page=$2<br>
                  &nbsp;RewriteRule ^/chatty/thread/([0-9]+)\.json$ /classic/getThread.php?id=$1<br>
                  &nbsp;RewriteRule ^/chatty/search\.json$ /classic/search.php<br>
                  &nbsp;RewriteRule ^/chatty/stories\.json$ /classic/getStories.php<br>
                  &nbsp;RewriteRule ^/chatty/stories/([0-9]+)\.json$ /classic/getArticle.php?story=$1<br>
                  &nbsp;RewriteRule ^/chatty/messages\.json$ /classic/getMessages.php<br>
                  &lt;/IfModule&gt;
               </tt>
            </li>
            <li>
               Block the <tt>data</tt>, <tt>include</tt>, and <tt>service/core</tt> directories
               in your Apache configuration.  These are backend directories that don't
               need to be exposed to the world.  You will need to adapt the paths
               to wherever you've placed the files physically on your server.<br>
               <tt>
                  &lt;Directory /home/user/winchatty.com/data/&gt;<br>
                  &nbsp;deny from all<br>
                  &lt;/Directory&gt;<br>
                  &lt;Directory /home/user/winchatty.com/include/&gt;<br>
                  &nbsp;deny from all<br>
                  &lt;/Directory&gt;<br>
                  &lt;Directory /home/user/winchatty.com/service/core/&gt;<br>
                  &nbsp;deny from all<br>
                  &lt;/Directory&gt;<br>
               </tt>
            </li>
            <li>
               The comments search indexer requires a crontab entry so it can periodically reindex.
               This functionality is optional.  If the crontab entry is not added, the search 
               will simply operate on an empty database.  Add a line to <tt>/etc/crontab</tt> that
               runs <tt>/include/_ManualSearchRefresh.php</tt>.  You choose the interval.  I've picked
               20 minutes.  The indexer will retrieve the minimum number of pages possible to update the
               cache, so running it relatively frequently is not a big deal.<br>
               <tt>
               00,20,40 * * * * www-data /home/user/winchatty.com/include/_ManualSearchRefresh.php
               </tt>
            </li>
         </ol>
      </p>
      <h2>Directory Structure</h2>
      <dl>
         <dt>classic/
         <dd>Contains the JSON services.  These scripts redirect the requests to the JSON gateway provided by AMFPHP.
         <dt>data/
         <dd>Contains serialized PHP objects that the WinChatty API uses in lieu of a database.  This includes user bookmarks and various cache files.
         <dt>doc/
         <dd>This documentation folder.
         <dt>hessian/
         <dd>Contains the <a href="http://sourceforge.net/projects/hessianphp/">HessianPHP</a> service gateway.
         <dt>include/
         <dd>This is where all the actual WinChatty API code lives.  The various service gateways (JSON, AMF, Hessian) are thin wrappers around this code.
         <dt>service/
         <dd>Contains the <a href="http://www.amfphp.org/">AMFPHP</a> service gateway.
      </dl>
   </body>
</html>